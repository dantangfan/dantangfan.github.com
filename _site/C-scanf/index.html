<!DOCTYPE html>
<html>
<head>
    <!--
    * Author:         dantangfan
    -->
    <meta charset="utf-8" />
    <title>C语言学习-让人头疼的scanf |  dantangfan </title>
    <meta name="author" content="dantangfan" />
    <meta name="description" content="hj's Blog" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>

    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">dantangfan</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/u/2428228892/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="https://github.com/dantangfan/" target="_blank" style="text-align:center;"><img src="https://github.com/favicon.ico" alt="" width="22"/></a>
            <a href="http://renren.com/419506097" target="_blank" style="text-align:right"><img src="http://iconpng.com/png/website_icons/renren.png" alt="" width="22"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/C-scanf" title="C语言学习-让人头疼的scanf">C语言学习-让人头疼的scanf</a></h1>
        <p class="entry-date">2012-12-15</p>
        <h2>stdin/stdout/stderr</h2>

<p>提到输入数出，最先要说的就是字节流，它是一种线性的数据结构。流是有方向的，就向您在阅读这篇文章的时候肯定是从左往右读下去的。</p>

<p>而任何流都是有源头，也有流向的，最长见的就是我们经常说到的I/O流。c语言为我们提供了三个流，一个是输入流stdin，默认指向的源头的键盘。还有两个流是stdout和stderr，默认情况下流向指向屏幕，也就是从屏幕输出。对任何一个输入输出函数，如果没有特殊的参数指明，默认都是从stdin读取字节，再从stdout输出。</p>

<p>虽然说stdout和stderr都是输出到屏幕，但是他们是有很大区别的。输出到stdout的内容首先要保存到缓冲区中，而stderr直接输出到屏幕（因为我们总是希望尽快就看到错误提示）。如果希望马上就的到错误信息，常用如下语句</p>

<pre><code>fprintf(stderr,"something wrong\n");
</code></pre>

<p>无论是stdin或者是stdout都是不可修改的，因为它们是常量。虽然c语言有提供重定向函数<code>freopen()</code>，但是一般不建议使用。</p>

<h2>字符输入输出函数</h2>

<p>在介绍scanf之前，我们还是循序渐进的现介绍以下他的兄弟连——各种字符输入输出函数。</p>

<p>首先是最简单的getchar(),putchar()，需要注意的是这两个函数都是读取一个字符，无论他是不是空白字符（这里的空白字符主要是指\n,\t,以及空格等）。虽然简单，但是还是可能出现一些小问题。</p>

<pre><code>char a,b;
getchar(a);
putchar('a');putchar(a);putchar('\n');
getchar(b);
putchar('b');putchar(b);putchar('\n');
</code></pre>

<p>首先，当我们输出xy再回车的时候，出现的我们预期的结果</p>

<pre><code>ax
by
</code></pre>

<p>但是当我们输入x回车的时候却出现了</p>

<pre><code>ax
b
</code></pre>

<p>这就是刚刚说的getchar(),putchar()会接收当下的任何字符，包括回车。</p>

<p>然后是字符串输入输出函数gets()和puts()。需要了解的就是gets()总是以回车结束，所以不会带走回车，但是可以带走中间的/t,/b等等空白符。</p>

<h2>scanf</h2>

<p>下面是本文的主要内容scanf。我们需要清楚两个关键的概念：缓冲区和空白符。空白符前面已经说过了，什么是缓冲区呢？在使用scanf或者gets函数的时候，键盘的输入最先都被保存在缓冲区中，直到输入回车，相应的输入函数才会从缓冲区中读取数据。输入函数从缓冲区读取数据的时候，如果缓冲区为空，函数将等待用户输入，如果不为空，会直接从缓冲区中读取字符。这是一个比较关键的概念，有助于理解下面的问题。</p>

<p>scanf的函数定义原型如下</p>

<pre><code>int scanf("格式",地参数);
</code></pre>

<p>可以看到，函数的返回值是int类型。实际上，scanf函数正确匹配了几个输入参数，返回值就是几。</p>

<p>下面一个例子来说明scanf函数的主要方面。</p>

<pre><code>scanf("%c,%s %d",&amp;ch,str,&amp;a);
</code></pre>

<p>要正确的输入该改函数，我们需要从键盘输入<code>字符,字符串 整数</code>，如果如果成功的读入，返回值将是3（而不是5）。在输入过程中，一定要在正确的位置输入<code>,</code>和<code></code>与格式匹配。如果不匹配，scanf会失败并且退出。值得注意的是，如果格式里面又空白字符，那么scanf会从stdin中读取空白字符匹配，直到遇到下一个非空白字符，也就是说输入两三个空白字符也是无所谓的。</p>

<p><code>scanf("%c",&amp;c)</code>在读取单个字符的时候跟<code>getchar()</code>完全一样，读取数字的时候只要类型匹配就对了，不必多说。最扰人的地方是读取字符串，而出事的关键就在于缓冲区！如果还不理解缓冲区，那就管会google一下</p>

<p>下面看一个几乎所有初学者都遇到过的问题</p>

<pre><code>int i;
while(1){
    printf("*");
    scanf("%d",&amp;i);
    if(i==1)
        break;
}
</code></pre>

<p>上面函数，只要任意输入一个非数字字符，函数就会陷入死循环不停的输出*，您最好亲自再试一试是不是这样的。</p>

<p>造成无限循环的原因就是scanf按照格式读取的时候失败自动退出，但是他<em>不会清空缓冲区</em>。于是，我们在输入错误一次后，比如说输入a，scanf发现不匹配，马斯就退出了，但是当下次循环时候，scanf发现缓冲区不空就不会等待输入，又继续匹配不成功，一直这样想去就死循环了。</p>

<p>那么，这时候我们就需要在每次匹配过后清空缓冲区，我是这样写的</p>

<pre><code>int a;
char c;
while(1){
    printf("*");
    scanf("%d",&amp;a);
    while((c=getchar)!='\n' &amp;&amp; c!=EOF)
        ;
    if(a==1)
        break;
}
</code></pre>

<p>有些书上说fflush(stdin)可以清空缓冲区，但是我在使用gcc的时候并没有成功。</p>

<h2>总结</h2>

<p>除了缓冲区和格式匹配之外，scanf还可能引发其他很多奇奇怪怪的问题。很多时候我们知道它错了，但是却不知道它为什么错了。所以把scanf说成c函数库中最复杂的函数之一是没问题的。</p>

<p>解决问题最好的方法就是不让他发生，所以在不熟悉的情况下，尽量使用其他函数来代替scanf，比如说先用fgets()来读取用户输入的整行，然后再用sscanf，strtol，atoi等函数来解析读取的行。这样的好处是，就算我们解析失败了，还可以用其他解析函数来重新解析fgets中的数据</p>

<p>最长用的算是sscanf了，他从字符串中读取与指定格式匹配的数据。比如说</p>

<pre><code>char buf[1024];
fgets(buf,sizeof(buf),stdin);
if(sscanf(buf,"%d %c %d",&amp;a,&amp;b,&amp;c)==3)
    printf("OK\n");
</code></pre>

<p>从上面罗嗦的过程中，我们可以简单总结出几个要点</p>

<ul>
<li><p>scanf输入字符的时候，任何字符都不会被忽视</p></li>
<li><p>scanf输入数字和字符串的时候，空白字符会被当成输入结束</p></li>
<li><p>键盘的输入都被保存到缓冲区，直到输入回车输入函数才会去读取缓冲区。输入函数读取缓冲区的时候，如果缓冲区为空，程序会等待输入；如果不为空，程序会直接读取缓冲区中字符</p></li>
<li><p>scanf读取成功会清空缓冲区，读取不成功不会清空缓冲区</p></li>
</ul>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
                <script type="text/javascript" charset="utf-8">
                (function(){
                  var _w = 86 , _h = 16;
                  var param = {
                    url:location.href,
                    type:'6',
                    count:'', /**是否显示分享数，1显示(可选)*/
                    appkey:'', /**您申请的应用appkey,显示分享来源(可选)*/
                    title:'', /**分享的文字内容(可选，默认为所在页面的title)*/
                    pic:'', /**分享图片的路径(可选)*/
                    ralateUid:'2428228892', /**关联用户的UID，分享微博会@该用户(可选)*/
                    language:'zh_cn', /**设置语言，zh_cn|zh_tw(可选)*/
                    rnd:new Date().valueOf()
                  }
                  var temp = [];
                  for( var p in param ){
                    temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
                  }
                  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'"></iframe>')
                })()
                </script>
            </div>
            <a href="#" class="comment" onclick="return false;">点击查看评论</a>
            <div id="disqus_thread"></div>
        </div>
    </div>

    <div class="sidenav">
        <iframe width="250" height="100" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=250&height=100&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=1&isWeibo=0&isFans=0&uid=2428228892&verifier=76bf5e3a&dpc=1"></iframe>
    </div>

    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/python-skills">python小技巧</a></li>
        
            <li><a href="/nothing">博客搬家</a></li>
        
            <li><a href="/command">重用命令记录</a></li>
        
            <li><a href="/study-tornado">Python Tornado学习</a></li>
        
            <li><a href="/findwork">学习记录</a></li>
        
            <li><a href="/diff-py2-py3">python2.7.x和python3.x的简单区别</a></li>
        
            <li><a href="/linotp">LinOTP使用报告</a></li>
        
            <li><a href="/process-signal">进程同步的若干问题</a></li>
        
            <li><a href="/memo">备忘录</a></li>
        
            <li><a href="/python-spider">简单爬虫</a></li>
        
            <li><a href="/learn-python">半天简单总结python</a></li>
        
            <li><a href="/raspberry-car">树莓派制作wifi控制小车</a></li>
        
            <li><a href="/c-memory">c语言学习-内存</a></li>
        
            <li><a href="/C-stander">C 语言编码风格和标准</a></li>
        
            <li><a href="/C-pointer">c语言学习-指针</a></li>
        
            <li><a href="/C-scanf">C语言学习-让人头疼的scanf</a></li>
        
            <li><a href="/learn-gitPage">使用Github Pages建独立博客</a></li>
        
        </ul>

        <h2>Opinion</h2>
        <ul class="artical-list">
        
            <li><a href="/Mybirthday">颓废</a></li>
        
            <li><a href="/yearOf2011">从一个地方到另一个地方</a></li>
        
        </ul>

        
        <a href="/project"><h2>About me</h2></a>
        <!--
        <h2>Project</h2>
        <ul class="artical-list">
        
        </ul>
        -->
    </div>
</div>

<script src="/js/post.js" type="text/javascript"></script>


    <script type="text/javascript">
        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })
    </script>
</body>
</html>
